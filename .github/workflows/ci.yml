name: CI Pipeline

on:
  push:
   branches: [ 'main' ]
  pull_request:
    branches: ['main']
  workflow_dispatch:

permissions:
  contents: write      # needed to create tags/releases
  packages: write      # needed for GHCR push
  id-token: write      # optional if you use OIDC for cloud deploys
  actions: read
 
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for quick-version to function properly

      - name: Package Options
        id: package_options
        shell: pwsh
        run: |
          $event = "${{ github.event_name }}"
          $ref   = "${{ github.ref_name }}"
          $base  = "${{ github.base_ref }}"

          $label = ""
          $build = $true
          if ($event -eq 'pull_request' -and $base -eq 'main') {
            $label = 'rc'
          }
          elseif ($event -eq 'push' -and $ref -eq 'main') {
            $label = ''   # explicit empty label
          }
          else {
            $label = 'none'
            $build = $false
          }

          # force lowercase boolean for consistent condition checks
          "label=$label" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "build=$($build.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Compute Version
        id: version
        uses: ./.github/actions/quick-version
        with:
          version-label: ${{ steps.package_options.outputs.label }}
          include-paths: 'src/;source/;lib/'
          exclude-paths: 'docs/;tests/;.github/'
          #build-metadata: 'sha${{ github.sha }}'

      - name: Display Version Info
        shell: pwsh
        run: |

          Write-Host "QuickVer.lastVersion: ${{ steps.version.outputs.lastVersion }}"
          Write-Host "QuickVer.nextVersionMajor: ${{ steps.version.outputs.nextVersionMajor }}"          
          Write-Host "QuickVer.nextVersionMinor: ${{ steps.version.outputs.nextVersionMinor }}"          
          Write-Host "QuickVer.nextVersionPatch: ${{ steps.version.outputs.nextVersionPatch }}"          
          Write-Host "QuickVer.nextVersionBuild: ${{ steps.version.outputs.nextVersionBuild }}"          
          Write-Host "QuickVer.major           : ${{ steps.version.outputs.major }}"          
          Write-Host "QuickVer.minor           : ${{ steps.version.outputs.minor }}"          
          Write-Host "QuickVer.patch           : ${{ steps.version.outputs.patch }}"          
          Write-Host "QuickVer.version         : ${{ steps.version.outputs.version }}"          
          Write-Host "QuickVer.label           : ${{ steps.version.outputs.label }}"          
          Write-Host "QuickVer.infoVersion     : ${{ steps.version.outputs.infoVersion }}"          

          Write-Host "Build Package: ${{ steps.package_options.outputs.build }}"
          Write-Host "Package Label: ${{ steps.package_options.outputs.label }}"
          Write-Host "Major: ${{ steps.version.outputs.major }}"
          Write-Host "Minor: ${{ steps.version.outputs.minor }}"
          Write-Host "Patch: ${{ steps.version.outputs.patch }}"
          Write-Host "Version: ${{ steps.version.outputs.version }}"
          Write-Host "InfoVersion: ${{ steps.version.outputs.infoVersion }}"


      # -------------------------------------------
      # Create Release Tag (push to staging and main only)
      # -------------------------------------------
      - name: Create Release Tag
        id: tags
        #if: ${{ github.event_name == 'workflow_dispatch' && inputs.create_release == 'yes' }}
        if: steps.package_options.outputs.build == 'true'
        shell: pwsh
        run: |
          $version = '${{ steps.version.outputs.version }}'
          if ([string]::IsNullOrWhiteSpace($version)) {
            Write-Error 'No version found from quick-version; aborting tag creation.'
            exit 1
          } 
          $tag = "v$version"
          Write-Host "Tagging release as $tag"
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag $tag
          git push origin $tag

      # -------------------------------------------
      # Re-checkout tag if one was just created
      # -------------------------------------------
      - name: Checkout Tag for Release
        if: steps.package_options.outputs.build == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: v${{ steps.version.outputs.version }}


      - name: Generate Package Artifacts (if applicable)
        if: ${{ steps.package_options.outputs.build == 'true' }}
        shell: pwsh
        run: |
          Write-Warning "Building package artifacts..."
          echo "Generating package artifacts for version ${{ steps.version.outputs.infoVersion }}..."
          # Add your packaging commands here