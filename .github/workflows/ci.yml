name: CI Pipeline

on:
  push:
   branches: [ 'main','staging' ]
  pull_request:
    branches: ['staging' ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for quick-version to function properly

      - name: Package Options
        id: package_options
        shell: pwsh
        run: |
          $event = "${{ github.event_name }}"
          $ref   = "${{ github.ref_name }}"
          $base  = "${{ github.base_ref }}"

          $label = ""
          $build = $true
          if ($event -eq 'pull_request' -and $base -eq 'staging') {
            $label = 'alpha'
          }
          elseif ($event -eq 'push' -and $ref -eq 'staging') {
            $label = 'beta'
          }
          elseif ($event -eq 'pull_request' -and $base -eq 'main') {
            $label = 'rc'
          }
          elseif ($event -eq 'push' -and $ref -eq 'main') {
            $label = ''   # explicit empty label
          }
          else {
            $label = 'none'
            $build = $false
          }

          # force lowercase boolean for consistent condition checks
          "label=$label" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "build=$($build.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Compute Version
        id: version
        uses: ./.github/actions/quick-version
        with:
          version-label: ${{ steps.package_options.outputs.label }}
          build-metadata: 'sha${{ github.sha }}'
          include-paths: 'src/;source/;lib/'
          exclude-paths: 'docs/;tests/;.github/'

      - name: Display Version Info
        shell: pwsh
        run: |
          Write-Host "Build Package: ${{ steps.package_options.outputs.build }}"
          Write-Host "Package Label: ${{ steps.package_options.outputs.label }}"
          Write-Host "Major: ${{ steps.version.outputs.major }}"
          Write-Host "Minor: ${{ steps.version.outputs.minor }}"
          Write-Host "Patch: ${{ steps.version.outputs.patch }}"
          Write-Host "Build: ${{ steps.version.outputs.build }}"
          Write-Host "Version: ${{ steps.version.outputs.version }}"
          Write-Host "InfoVersion: ${{ steps.version.outputs.infoVersion }}"

      - name: Generate Package Artifacts (if applicable)
        if: ${{ steps.package_options.outputs.build == 'true' }}
        shell: pwsh
        run: |
          Write-Warning "Building package artifacts..."
          echo "Generating package artifacts for version ${{ steps.version.outputs.infoVersion }}..."
          # Add your packaging commands here